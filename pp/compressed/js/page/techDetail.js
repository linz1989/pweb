require(["css!../../compressed/css/page/"+$$.rootVm.page+".css?"+$$.rootVm.currTime,"colorbox","!domReady"],function(){function e(e){$.ajax({url:"tech/update/data",type:"post",data:{id:h.id,ajax:1},success:function(a){a&&a.data?e===!0?a.category&&(t(a),o()):(f.isRecommend=a.data.recommend||"N",f.techInfoObj=a.data,f.albums=a.albums||[],a.category&&t(a),a.albums&&(f.albumsNum=a.albums.length),avalon.scan(g[0]),$("a.techHeader").colorbox({rel:"techHeader",maxWidth:"90%",maxHeight:"90%"}),o()):(msgAlert("数据查询失败！"),history.back())}})}function t(e){for(var t,a,s=0;s<e.category.length;s++){for(t=[],a=0;a<e.category[s].serviceItems.length;a++)t.push(e.category[s].serviceItems[a].name);e.category[s].items=t.join("、")}d=e.category,f.serviceItems=e.category}function a(e){e=e||1,$.ajax({url:"api/v2/manager/tech/orders",type:"post",data:{techId:h.id,page:e,pageSize:f.orderListPageSize,status:f.currQueryStatus},success:function(t){200==t.statusCode?(f.orderList=t.respData,n.refresh({currPage:e,totalPage:t.pageCount})):f.orderList=[]}})}function s(e){e=e||1,$.ajax({url:"api/v2/manager/tech/comments",type:"post",data:{techId:h.id,page:e,pageSize:f.commentListPageSize},success:function(t){200==t.statusCode?(f.commentList=t.respData,r.refresh({currPage:e,totalPage:t.pageCount})):f.commentList=[]}})}function o(){$.ajax({url:"club/service/data",data:{select:1},success:function(e){if(200==e.statusCode){e=e.respData;for(var t,a,s=0;s<e.length;s++)for(a=i(e[s].name),a&&a.serviceItems.length==e[s].serviceItems.length?e[s].selected=!0:e[s].selected=!1,t=0;t<e[s].serviceItems.length;t++)a&&inArr(e[s].serviceItems[t].id,a.serviceItems,"id")?e[s].serviceItems[t].selected=!0:e[s].serviceItems[t].selected=!1;f.serviceList=e||[]}}})}function i(e){for(var t=0;t<d.length;t++)if(d[t].name==e)return d[t];return null}function c(e,t){for(var a=0;a<e.length;a++)if(e[a]==t)return;e.push(t)}var n,r,m,d,u,l=$$.rootVm.page+"Ctrl"+ +new Date,g=$("#"+$$.rootVm.page+"Page"),h=getParamObj();h.id||(msgAlert("地址栏缺少访问参数！"),history.back()),g.attr("ms-controller",l),$$.currPath.html("技师管理 >> <a href='#!/techList'>所有技师</a> >> 技师详情");var f=avalon.define({$id:l,techId:h.id,orderList:[],techInfoObj:{},serviceItems:[],albumsNum:0,currQueryStatus:"",orderListPageSize:15,commentListPageSize:15,orderStatus:[{name:"已完成",value:"complete"},{name:"待接受",value:"submit"},{name:"已接受",value:"accept"},{name:"已拒绝",value:"reject"},{name:"失效",value:"failure"},{name:"超时",value:"overtime"}],commentList:[],selectedTab:"order",isRecommend:"N",opeType:"",confirmContent:"",albums:"",serviceList:[],doChangeQueryStatus:function(){f.currQueryStatus=this.value,a()},onChangeOrderListPageSize:function(){f.orderListPageSize=this.value,a()},onChangeCommentListPageSize:function(){f.commentListPageSize=this.value,s()},doChangeTab:function(e){f.selectedTab=e},doChangeRecommend:function(){f.opeType="recommend","Y"==f.isRecommend?f.confirmContent="确定取消该技师的首页推荐？":f.confirmContent="确定将该技师推荐到首页？",m.show()},doDeleteTech:function(){f.opeType="del",f.confirmContent="确定将该技师删除？",m.show()},doClickDeleteComment:function(e){$("#confirmModal").attr("commentId",e),f.opeType="delComment",f.confirmContent="确定将这条评论删除？",m.show()},doClickEditServiceItem:function(){u.show()},doCategoryAllCheck:function(){var e="active"==this.className?"":"active",t=$(this).parents("tbody").find("tr.item>td>i");e?t.addClass("active"):t.removeClass("active"),this.className=e},doServiceItemCheck:function(){var e="active"==this.className?"":"active",t=$(this).parents("tbody"),a=t.find("tr.group>td>i");this.className=e,""==e?a[0].className="":t.find("tr.item>td>i.active").length==t.find("tr.item>td>i").length&&(a[0].className="active")}});n=new Pagination($("#orderListPagination"),{switchPage:function(e){a(e)}}),r=new Pagination($("#commentListPagination"),{switchPage:function(e){s(e)}}),m=new Modal($("#confirmModal"),{doClickOkBtn:function(){"recommend"==f.opeType?$.ajax({url:"api/v2/manager/tech/recommend",data:{id:h.id},success:function(e){200==e.statusCode?(msgAlert(e.msg,!0),f.isRecommend="Y"==f.isRecommend?"N":"Y"):msgAlert(e.msg)}}):"del"==f.opeType?$.ajax({url:"tech/delete/"+h.id,success:function(e){m.close(),200==e.statusCode?(msgAlert(e.message,!0),location.href="#!/techList"):msgAlert(e.message||"操作失败！")}}):"delComment"==f.opeType&&$.ajax({url:"api/v2/manager/tech/comments/delete",data:{commentId:$("#confirmModal").attr("commentId")},success:function(e){200==e.statusCode?(msgAlert(e.msg,!0),s()):msgAlert(e.msg||"删除失败！")}}),m.close()}}),u=new Modal($("#editServiceItemModal"),{doClickOkBtn:function(){var t,a=[],s=[],o=$("#serviceItemTable>tbody>tr.item>td>i.active");for(t=0;t<o.length;t++)s.push(o[t].getAttribute("itemId")),c(a,o[t].getAttribute("categoryId"));u.loading(),$.ajax({url:"tech/service/update",type:"post",traditional:!0,data:{id:h.id,services:s,categoryId:a},success:function(t){u.loading("hide"),200==t.statusCode?(u.close(),msgAlert(t.message,!0),e(!0)):u.showTip(t.message)}})}}),e(),a(),s()});
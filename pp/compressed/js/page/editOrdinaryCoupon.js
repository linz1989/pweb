require(["css!../../compressed/css/page/"+$$.rootVm.page+".css?"+$$.rootVm.currTime,"daterangepicker","!domReady"],function(){function e(){if(!h.canEdit)return!0;if(!c.val())return msgAlert("请输入优惠券名称！"),c.focus(),!1;if("money"==h.currUseType&&!l.val())return msgAlert("请输入减免金额！"),l.focus(),!1;if("coupon"==h.currUseType&&!p.val())return msgAlert("请输入优惠价格！"),p.focus(),!1;if(0==a().length)return msgAlert("使用时段请至少选择一天！"),!1;if("fixed_time"==h.currPeriodType&&d.val()&&m.val()){var e=formatDateRangeVal(d.val()),t=formatDateRangeVal(m.val());if(e.start<t.start)return msgAlert("券有效开始时间不能小于活动开始时间！"),!1;if(t.end>e.end)return msgAlert("活动时间不能大于券有效时间"),!1}if("ordinary"==h.currCouponType){if(""!=s.val()&&0==s.val())return msgAlert("发放数量不能为0！"),s.focus(),!1;if(""!=u.val()&&0==u.val())return msgAlert("领券限制不能为0！"),u.focus(),!1}return!0}function a(){for(var e=$("div.useTime>div>span.active"),a=[],t=0;t<e.length;t++)a.push(e[t].getAttribute("weekDay"));return a}function t(){for(var e=[],a=$("div.items li.active"),t=0;t<a.length;t++)e.push(a[t].getAttribute("itemId"));return e}var r,n=$$.rootVm.page+"Ctrl"+ +new Date,o=$("#"+$$.rootVm.page+"Page"),i=getParamObj(),s=$("#couponTotal"),u=$("#userGetCount"),c=$("#couponName"),l=$("#actValueOfMoney"),p=$("#actValueOfCoupon"),d=$("#couponPeriodRange"),m=$("#sellDateRange"),v=$("#consumeOfMoneyType"),f=$("#consumeOfCouponType"),y=$("#sellDateRangeOfNoEdit"),T={};o.attr("ms-controller",n),$$.currPath.html("营销中心 >> <a href='#!/ordinaryCouponSell'>优惠券</a> >> "+(i.id?"编辑优惠券":"添加优惠券")),$("#editActContent").html("<ul><li>使用时，请出示手机号码或者优惠码。</li><li>每张券仅限一人使用，仅能使用一张。</li><li>使用此券，不可享受本店其他优惠。</li><li>提供免费WiFi。</li><li>提供免费停车位。</li><li>欢迎提前预约。</li>");var D=new Date,g=new Date;g.setTime(D.getTime()+2592e6),d.daterangepicker({startDate:D,endDate:g},function(e,a){}),d.val(""),m.daterangepicker({startDate:D,endDate:g},function(e,a){}),m.val("");var h=avalon.define({$id:n,canEdit:!0,effectDayArr:[],effectiveDayArr:[],useStartTimeArr:[],useEndTimeArr:[],weekArr:[{name:"周一",value:"1"},{name:"周二",value:"2"},{name:"周三",value:"3"},{name:"周四",value:"4"},{name:"周五",value:"5"},{name:"周六",value:"6"},{name:"周日",value:"0"}],sellStyle:"",serveArr:[],couponObj:{},doClickItem:function(){this.className="active"==this.className?"":"active"},currCouponType:"redpack",doSelectCouponType:function(e){h.currCouponType=e},currUseType:"money",doSelectUseType:function(e){h.currUseType=e},currPeriodType:"fixed_time",doSelectPeriodType:function(e){h.currPeriodType=e},doChangeUseStartTime:function(){var e=[{name:"请选择",value:""}];if(""!=this.value)for(r=parseInt(this.value)+1;r<24;r++)e.push({name:r+":00",value:r});h.useEndTimeArr=e},doSave:function(r){e()&&(h.canEdit?$.ajax({url:"act/modify",type:"post",data:{operator:i.id?"modify":"add",saveType:r,actId:i.id||"",actType:"coupon",useType:h.currUseType,couponType:h.currCouponType,itemId:t().join(","),actTitle:c.val(),actValue:"money"==h.currUseType?l.val():p.val(),consumeMoney:("money"==h.currUseType?v.val():f.val())||"0",actTotal:s.val()||"0",userGetCount:""==u.val()?1:u.val(),commission:"redpack"==h.currCouponType?$("#commissionOfRedpackShare").val():$("#commissionOfOrdinaryShare").val(),startDate:formatDateRangeVal(m.val()).start,endDate:formatDateRangeVal(m.val()).end,periodType:h.currPeriodType,longAfterReceive:$("#longAfterReceive").val(),useDay:a().join(","),periodDay:"after_receive"==h.currPeriodType?$("#afterReceiveSelect").val():"",useStartDate:"fixed_time"==h.currPeriodType?formatDateRangeVal(d.val()).start:"",useEndDate:"fixed_time"==h.currPeriodType?formatDateRangeVal(d.val()).end:"",actContent:$("#editActContent").html(),startTime:$("#useStartTime").val(),endTime:$("#useEndTime").val(),actDescription:""},success:function(e){200==e.statusCode?(msgAlert(e.msg,!0),location.href="#!/ordinaryCouponSell"):msgAlert(e.msg||"操作失败！")}}):$.ajax({url:"act/modify",type:"post",data:{operator:"modify",saveType:r,actId:i.id,actType:"coupon",useType:h.couponObj.pa.useType,couponType:h.couponObj.pa.couponType,itemId:h.couponObj.pa.itemIds,actTitle:h.couponObj.pa.actTitle,actValue:h.couponObj.pa.actValue,consumeMoney:h.couponObj.pa.consumeMoney,actTotal:h.couponObj.pa.actTotal,userGetCount:h.couponObj.pa.userGetCount,commission:h.couponObj.pa.commission,startDate:formatDateRangeVal(y.val()).start,endDate:formatDateRangeVal(y.val()).end,periodType:h.couponObj.pa.periodType,longAfterReceive:h.couponObj.pa.longAfterReceive,useDay:h.couponObj.pa.useDay,periodDay:h.couponObj.pa.periodDay,useStartDate:h.couponObj.pa.useStartDate,useEndDate:h.couponObj.pa.useEndDate,actContent:h.couponObj.pa.actContent,startTime:h.couponObj.pa.startTime,endTime:h.couponObj.pa.endTime,actDescription:""},success:function(e){200==e.statusCode?(msgAlert(e.msg,!0),location.href="#!/ordinaryCouponSell"):msgAlert(e.msg||"操作失败！")}}))},initRenderedOfLongAfterReceive:function(){T.longAfterReceive&&($("#longAfterReceive").val(T.longAfterReceive),delete T.longAfterReceive)},initRenderedOfAfterReceiveSelect:function(){T.periodDay&&($("#afterReceiveSelect").val(T.periodDay),delete T.periodDay)},initRenderedOfWeekArr:function(){if(T.useDay){var e,a=$("div.useTime>div>span");for(e=0;e<a.length;e++)T.useDay.indexOf(a[e].getAttribute("weekDay"))>=0?a[e].className="active":a[e].className="";delete T.useDay}},initRenderedOfUseStartTimeArr:function(){T.startTime&&($("#useStartTime").val(T.startTime),delete T.startTime)},initRenderedOfUseEndTimeArr:function(){T.endTime&&($("#useEndTime").val(T.endTime),delete T.endTime)},initRenderedOfServeArr:function(){if(T.items){var e,a=$("div.items ul.item>li"),t=[];for(e=0;e<T.items.length;e++)t.push(T.items[e].id);for(e=0;e<a.length;e++)inArr(a[e].getAttribute("itemId"),t)&&(a[e].className="active");delete T.items}}}),A=[{name:"当天",value:"0"}],O=[];for(r=1;r<=90;r++)A.push({name:r+"天后",value:r}),O.push({name:r+"天",value:r});h.effectDayArr=A,h.effectiveDayArr=O;var C=[{name:"请选择",value:""}];for(r=0;r<24;r++)C.push({name:r+":00",value:r});h.useStartTimeArr=C,h.useEndTimeArr=C,c.on("input",function(){this.value.length>30&&(this.value=this.value.substr(0,30)),/\s/.test(this.value)&&(this.value=this.value.replace(/\s/g,""))}),$("#actValueOfMoney,#actValueOfCoupon,#consumeOfMoneyType,#consumeOfCouponType,#commissionOfRedpackShare,#commissionOfOrdinaryShare,#couponTotal,#userGetCount").on("input",function(){/\D/.test(this.value)&&(this.value=this.value.replace(/\D/g,"")),this.value.length>6&&(this.value=this.value.substr(0,6))}),$.ajax({url:"club/service/data",data:{select:1},success:function(e){200==e.statusCode&&(h.serveArr=e.respData,i.id?$.ajax({url:"act/get/"+i.id,success:function(e){if(200==e.statusCode)if(e=e.respData,h.canEdit="not_online"==e.pa.actStatus,h.canEdit)h.currUseType=e.pa.useType,c.val(e.pa.actTitle),"money"==h.currUseType?(l.val(e.pa.actValue),v.val(e.pa.consumeMoney)):(p.val(e.pa.actValue),f.val(e.pa.consumeMoney)),T.longAfterReceive=e.pa.longAfterReceive,h.currPeriodType=e.pa.periodType,"fixed_time"==h.currPeriodType?e.pa.useStartDate&&e.pa.useEndDate?(d.data("daterangepicker").setStartDate(e.pa.useStartDate),d.data("daterangepicker").setEndDate(e.pa.useEndDate)):d.val(""):T.periodDay=e.pa.periodDay,e.pa.startDate&&e.pa.endDate&&(m.data("daterangepicker").setStartDate(e.pa.startDate),m.data("daterangepicker").setEndDate(e.pa.endDate)),T.useDay=e.pa.useDay,T.startTime=e.pa.startTime,T.endTime=e.pa.endTime,T.items=e.items,$("#editActContent").html(e.pa.actContent),h.currCouponType=e.pa.couponType,$("#commissionOfRedpackShare").val(e.pa.commission),$("#commissionOfOrdinaryShare").val(e.pa.commission),"ordinary"==h.currCouponType&&(s.val(e.pa.actTotal),u.val(e.pa.userGetCount)),avalon.scan(o[0]);else{var a,t=[],r=[];for(a=0;a<e.items.length;a++)t.push(e.items[a].name),r.push(e.items[a].id);if(e.pa.items=t.join("、")||"无",e.pa.itemIds=r.join(","),h.couponObj=e,$("#actContent").html(e.pa.actContent),e.pa.startDate&&e.pa.endDate)y.daterangepicker({startDate:e.pa.startDate,endDate:e.pa.endDate},function(e,a){});else{var n=new Date,i=new Date;i.setTime(n.getTime()+2592e6),y.daterangepicker({startDate:n,endDate:i},function(e,a){}),y.val("")}avalon.scan(o[0])}else msgAlert(e.msg||"未能获取优惠券信息！"),location.href="#!/ordinaryCouponSell"}}):(h.useEndTimeArr=[{name:"请选择",value:""}],avalon.scan(o[0])))}})});
require(["css!../../compressed/css/page/"+$$.rootVm.page+".css?"+$$.rootVm.currTime,"qrcode","!domReady"],function(){function e(e,t){$.ajax({url:"message/updateStatus",data:{messageId:e,status:"Y"==t?"N":"Y"},success:function(t){M[e]=!1,200==t.statusCode?(msgAlert(t.msg,!0),s(P.currPage),o()):msgAlert(t.msg||"操作失败!")}})}function t(e){var t=e.split(" "),a=t[0].split("-"),n=t[1].split(":");return new Date(parseInt(a[0]),parseInt(a[1])-1,parseInt(a[2]),parseInt(n[0]),parseInt(n[1]),parseInt(n[2]))}function a(e){var t=parseInt(e/3600);e%=3600;var a=parseInt(e/60),n=e%60;return t+"小时"+(a<10?"0"+a:a)+"分钟"+(n<10?"0"+n:n)+"秒"}function n(){var e=0;for(i||(i=$("#messageChargeModal>div>div.content>ul>li")),p=0;p<i.length;p++)e+=parseFloat(i[p].children[1].innerHTML)*parseInt(i[p].children[2].children[1].value||0);P.chargeTotal=e.toFixed(2)}function s(e){e=e||1,P.currPage=e,$.ajax({url:"message/list",data:{page:e,pageSize:P.pageSize},success:function(t){200==t.statusCode?(t.respData=t.respData.messages||[],P.messages=t.respData,M={},r.refresh({currPage:e,totalPage:t.pageCount}),avalon.scan(C[0])):msgAlert(t.msg||"数据查询失败！")}})}function o(){$.ajax({url:"message/count",success:function(e){200==e.statusCode&&(e=e.respData,P.availableCount=e.availableCount||0,P.waitingCount=e.waitingCount||0,P.userCount=e.userCount||0,P.monthSendCount=e.monthSentCount||0,P.totalSendCount=e.totalSentCount||0,P.userMonthLimitCount=e.userMonthLimitCount||0)}})}var r,i,l,u,c,d,g,m,h,v=$$.rootVm.page+"Ctrl"+ +new Date,C=$("#"+$$.rootVm.page+"Page"),p=0,f=!1,S=$("#messagePayQrcodeModal>div>div.content>span"),I=$("#confirmQuickSendModal"),M={};C.attr("ms-controller",v),$$.currPath.html("营销中心 >> 短信营销");var P=avalon.define({$id:v,pageSize:15,currPage:iSessionStorage("messageSell-currPage")||1,messages:[],availableCount:0,userCount:0,waitingCount:0,monthSendCount:0,totalSendCount:0,userMonthLimitCount:0,dicts:{status:{Y:"启用",N:"禁用"},sendStatus:{Y:"已发送",N:"未发送",I:"发送中",W:"等待发送"},receiverFrom:{1:"活跃用户",2:"有效用户",3:"全部用户",4:"指定用户"}},chargeTotal:0,messagePlans:[],clubId:"",switchMsgStatus:function(a,n,s){1!=M[a]&&(M[a]=!0,"N"==n?t(s).getTime()>+new Date?e(a,n):(I.attr("mid",a),I.attr("mStatus",n),d.show()):e(a,n))},reSendFailureMsg:function(e){$("#confirmReSendModal>div>div.content").attr("recordId",e),u.show()},doViewMessageDetail:function(e,t){iSessionStorage("messageSell-currPage",P.currPage),location.href="#!/messageSellDetail?id="+e+"&editable="+t}});r=new Pagination($("#dataListPagination"),{switchPage:function(e){s(e)}}),d=new Modal(I,{doClickOkBtn:function(){e(I.attr("mid"),I.attr("mStatus")),d.close()},doClickCancelBtn:function(){M[I.attr("mid")]=!1,d.close()}}),l=new Modal($("#messageChargeModal"),{doClickOkBtn:function(){if(!f){if(i||(i=$("#messageChargeModal>div>div.content>ul>li")),0==P.chargeTotal)return void l.showTip("当前您选择的套餐总价为0！");for(var e,t=[],n=[],s=0;s<i.length;s++)e=i[s].children[2].children[1].value||0,0!=e&&(t.push(i[s].getAttribute("plan-id")),n.push(e));l.loading(),f=!0,$.ajax({url:"message/recharge/save",data:{PLAN_messagePlanId:t,PLAN_bookCount:n,clubId:P.clubId,totalPrice:P.chargeTotal},traditional:!0,success:function(e){f=!1,l.loading("hide"),200==e.statusCode?2==e.respData.type?(l.close(),$("#messagePayQrcodeModal>div>div.content>div").html(""),$("#messagePayQrcodeModal>div>div.content>div").qrcode({width:256,height:256,text:e.respData.payUrl}),c.show(),m=7200,S.html("剩余有效时间："+a(m)+",若已支付请关闭"),g&&clearInterval(g),g=setInterval(function(){m--,m<0?(clearInterval(g),S.html("已超过支付有效时间，请重新下单！")):S.html("剩余有效时间："+a(m)+",若已支付请关闭")},1e3),h&&clearInterval(h),h=setInterval(function(){$.ajax({url:"message/recharge/status",data:{orderNo:e.respData.orderNo},success:function(e){200==e.statusCode&&(msgAlert("充值成功！",!0),c.close())}})},5e3)):location.href=e.respData.payUrl:msgAlert(e.msg||"购买请求失败！")}})}}}),c=new Modal($("#messagePayQrcodeModal"),{afterClose:function(){g&&clearInterval(g),h&&clearInterval(h),o()}}),u=new Modal($("#confirmReSendModal"),{doClickOkBtn:function(){u.close(),$.ajax({url:"message/sendFails",data:{messageId:$("#confirmReSendModal>div>div.content").attr("recordId")},success:function(e){msgAlert(e.msg,200==e.statusCode),s(P.currPage),o()}})}}),$("#messageSendRecord>table>thead>tr:eq(0)>th>div>select").on("change",function(){P.pageSize=this.value,s()}),$("#messageChargeBtn").click(function(){i||(i=$("#messageChargeModal>div>div.content>ul>li"));for(var e=0;e<i.length;e++)i[e].children[2].children[1].value=0;P.chargeTotal=0,f=!1,l.show()}),$("#messageChargeModal>div>div.content>ul").on("input","li>div.ope>input",function(){/\D/.test(this.value)&&(this.value=this.value.replace(/\D/g,"")),this.value.length>6&&(this.value=this.value.substr(0,6)),n()}).on("click","li>div.ope>i",function(){var e=$(this),t=e.siblings("input");"+"==this.innerHTML?t.val(parseInt(t.val()||0)+1):t.val().length>0&&0!=t.val()&&t.val(parseInt(t.val())-1),n()}),$.ajax({url:"message/count",success:function(e){200!=e.statusCode?msgAlert(e.msg||"数据查询失败！"):(e=e.respData,P.availableCount=e.availableCount||0,P.waitingCount=e.waitingCount||0,P.userCount=e.userCount||0,P.monthSendCount=e.monthSentCount||0,P.totalSendCount=e.totalSentCount||0,P.userMonthLimitCount=e.userMonthLimitCount||0,s(P.currPage),avalon.scan(C[0]),$.ajax({url:"message/recharge/edit",success:function(e){200==e.statusCode&&(P.messagePlans=e.respData.messagePlans||[],P.clubId=e.respData.clubId)}}))}}),iSessionStorage("messageSell-currPage","")});
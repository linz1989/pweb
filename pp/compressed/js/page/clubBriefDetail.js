require(["css!../../compressed/css/page/"+$$.rootVm.page+".css?"+$$.rootVm.currTime,"kindeditor","kindeditor_zhCn","jqform","cropper","!domReady"],function(){function i(){return u.currId?u.currImageId?l.val()&&l.val().trim()?!(!d.val()||!d.val().trim())||(msgAlert("请输入简介！"),d.focus(),!1):(msgAlert("请输入标题！"),l.focus(),!1):(msgAlert("请您上传图片！"),!1):(msgAlert("ID为空！"),!1)}function e(){KindEditor.create("#detailContent",{resizeType:1,pasteType:1,width:"84%",minHeight:"400px",showLocal:!1,resizeMode:1,cssData:'body {font-family: "微软雅黑"; font-size: 16px; color: #4d4d4d; overflow-x:hidden}',allowUpload:!0,uploadJson:"club/uploadImage?width=535",afterBlur:function(){this.sync()},items:["fontname","fontsize","|","forecolor","hilitecolor","bold","italic","underline","removeformat","|","justifyleft","justifycenter","justifyright","insertorderedlist","insertunorderedlist","|","image","link"]})}var t,a,o=$$.rootVm.page+"Ctrl"+ +new Date,r=$("#"+$$.rootVm.page+"Page"),l=$("#briefTitle"),d=$("#briefInfo"),s=$("#detailContent"),n=$("#uploadImgModal>div>div.content"),m=$("#editImg"),c=getParamObj();if(!c.ope||!c.id)return msgAlert("页面访问参数错误！"),void history.back();r.attr("ms-controller",o),$$.currPath.html("资料设置 >> <a href='#!/clubBriefSetting'>会所简介</a> >> "+("add"==c.ope?"新增简介":"编辑简介"));var u=avalon.define({$id:o,currEditOpe:c.ope,currId:c.id,currImageId:"",uploadBtnStr:"上传图片",doClickOfUploadImg:function(){t.clean(),n.removeClass("hasImg"),a.show()},doClickSaveBtn:function(){i()&&$.ajax({url:"club/item/create",type:"post",data:{id:u.currId,image:u.currImageId,title:l.val().trim(),intro:d.val().trim(),description:s.val()},success:function(i){200==i.statusCode?(msgAlert("add"==u.currEditOpe?"新增成功！":"修改成功！",!0),location.href="#!/clubBriefSetting"):msgAlert(i.msg||"操作失败！")}})}});a=new Modal($("#uploadImgModal"),{doClickOkBtn:function(){if($("#imgForm>div>img")[0]&&0!=$("#imgForm>div>img")[0].width)if($("#uploadImgBtn")[0].files[0]){var i=t.checkSelectionValidate();if("OK"!=i)return void a.showTip(i);a.loading(),$("#imgForm").ajaxSubmit({dataType:"json",success:function(i){i&&i.image?(a.close(),u.currImageId=i.image,m.show(),m[0].src="updateImageInfo/imageView/"+u.currImageId,u.uploadBtnStr="修改图片",$("#clubBriefForm>div.img").addClass("hasImg")):a.showTip("图片上传失败！")},complete:function(i){a.loading("hide"),400==i.status&&a.showTip("您选择的裁剪区域过大！请通过鼠标缩小区域！")}})}else a.close();else a.showTip("请您上传图片！")}}),t=new iCropper({imgFile:$("#uploadImgBtn")[0],img:$("#imgForm>div>img")[0],imgName:$("#imgFileName")[0],imgId:$("#imageId")[0],selectionTxt:$("#imgForm>div>span.selectionTxt")[0],maxWidth:580,maxHeight:300,x:$("#x")[0],y:$("#y")[0],w:$("#w")[0],h:$("#h")[0],imgWidth:688,imgHeight:408,ratioW:688,ratioH:408,onImgLoad:function(){n.hasClass("hasImg")||n.addClass("hasImg")}}),l.on("input",function(){this.value.length>15&&(this.value=this.value.substr(0,15))}),d.on("input",function(){this.value.length>30&&(this.value=this.value.substr(0,30))}),e(),"add"==c.ope?(l.val(""),s.val(""),KindEditor.html("#detailContent",""),d.val(""),m[0].src="",m.hide(),u.uploadBtnStr="上传图片",u.currImageId="",$("#clubBriefForm>div.img").removeClass("hasImg"),avalon.scan(r[0])):$.ajax({url:"club/item/info/"+c.id,success:function(i){i&&i.clubId?(l.val(i.title),s.val(i.description),KindEditor.html("#detailContent",i.description),d.val(i.intro),u.currImageId=i.image,i.imageUrl?(m[0].src=i.imageUrl,m.show(),u.uploadBtnStr="修改图片",$("#clubBriefForm>div.img").addClass("hasImg")):(m[0].src="",m.hide(),u.uploadBtnStr="上传图片",$("#clubBriefForm>div.img").removeClass("hasImg")),avalon.scan(r[0])):(msgAlert("数据查询失败！"),history.back())}})});
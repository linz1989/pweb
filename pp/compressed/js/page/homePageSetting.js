require(["css!../../compressed/css/page/"+$$.rootVm.page+".css?"+$$.rootVm.currTime,"jqform","cropper","dragsort","!domReady"],function(){function e(){return!("add"==l.currEditOpe&&!$("#imgFileName").val())||(a.showTip("请上传会所图片！"),!1)}function t(){$.ajax({url:"club/banner/data",success:function(e){e&&e.data&&(l.list=e.data),avalon.scan(o[0])}})}var i,a,r,d=$$.rootVm.page+"Ctrl"+ +new Date,o=$("#"+$$.rootVm.page+"Page"),n=$("#actTitle"),s=$("#editForm");o.attr("ms-controller",d),$$.currPath.html("资料设置 >> 首页展示");var l=avalon.define({$id:d,list:[],confirmContent:"",opeType:"",opeId:"",editStr:"添加图片",currEditOpe:"add",currId:"",currImageId:"",doClickDelBtn:function(e){l.confirmContent="确认删除此图片？",l.opeType="delete",l.opeId=e,i.show()},doClickOfAddNew:function(){l.editStr="添加图片",l.currEditOpe="add",l.currId="",l.currImageId="",n.val(""),$("#imgLink").val(""),s.removeClass("hasImg"),r.clean(),a.show()},doClickEditBtn:function(e){l.editStr="编辑图片",l.currEditOpe="modify",l.currId=l.list[e].id,l.currImageId=l.list[e].image,$("#imgLink").val(l.list[e].link||""),r.load(l.list[e].imageUrl,{autoCropArea:1,disabled:!0}),s.addClass("hasImg"),a.show()}});i=new Modal($("#confirmModal"),{doClickOkBtn:function(){i.close(),$.ajax({url:"club/banner/delete/"+l.opeId,success:function(e){200==e.statusCode?(msgAlert("删除成功！",!0),t()):msgAlert(e.msg||e.message||"操作失败！")}})}}),a=new Modal($("#editModal"),{doClickOkBtn:function(){if(e()){var i=r.checkSelectionValidate();if("OK"!=i)return void a.showTip(i);a.loading("show"),s.ajaxSubmit({url:"add"==l.currEditOpe?"club/banner/create":"club/banner/update",dataType:"json",success:function(e){200==e.statusCode?(msgAlert("add"==l.currEditOpe?"图片添加成功！":"图片修改成功！",!0),a.close(),t()):a.showTip(e.message||"操作失败！")},complete:function(e){a.loading("hide"),400==e.status&&a.showTip("您选择的裁剪区域过大！请通过鼠标缩小区域！")}})}}}),r=new iCropper({imgFile:$("#uploadImgBtn")[0],img:$("#editForm>div.img>img")[0],imgName:$("#imgFileName")[0],imgId:$("#imageId")[0],selectionTxt:$("#editForm>div.img>span.selectionTxt")[0],maxWidth:580,maxHeight:300,x:$("#x")[0],y:$("#y")[0],w:$("#w")[0],h:$("#h")[0],imgWidth:360,imgHeight:204,ratioW:2,ratioH:1,onImgLoad:function(){s.hasClass("hasImg")||s.addClass("hasImg")}}),$("#imgLink").on("keyup",function(e){var t=this.value,i=e.which;if(t=t.replace(/\s+/g,""),t.length>4){if(17==i)return void(this.value=t);"http"!=t.substring(0,4)&&(t="http://"+t)}return this.value=t,!1}),$("#bannerList").dragsort({dragSelector:"li",dragSelectorExclude:"div>ul>li",dragEnd:function(){for(var e=$(this),t=e.parents("ul").children(),i=[],a=0;a<t.length;a++)i.push(t[a].getAttribute("imgId"));$.ajax({url:"club/banner/sort",type:"post",data:{ids:i.join(","),clubId:l.list[0].clubId},success:function(e){200==e.statusCode&&msgAlert("操作成功！",!0)}})}}),t()});
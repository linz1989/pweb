require(["css!../../compressed/css/page/"+$$.rootVm.page+".css?"+$$.rootVm.currTime,"amap","qrcode","cropper","jqform","!domReady"],function(){function e(){return f.val()?m.val()?h.val()?h.val()==m.val()||(h.focus(),c.showTip("两次输入的新密码不一致！"),!1):(h.focus(),c.showTip("请再次输入新密码！"),!1):(m.focus(),c.showTip("请输入新的密码！"),!1):(f.focus(),c.showTip("请输入当前密码！"),!1)}function a(){return w.val()?x.val()&&!/^1[34578]\d{9}$/.test(x.val())?(s.showTip("请输入正确的手机号码！"),x.focus(),!1):!(L.val()&&!/^([\.a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(\.[a-zA-Z0-9_-])+/.test(L.val()))||(s.showTip("请输入正确的电子邮箱！"),L.focus(),!1):(s.showTip("请输入会所名称！"),w.focus(),!1)}function o(){var e,a=[],o=$("#clubInfoModal>div>div.content>div.tel>input");for(e=0;e<o.length;e++)o[e].value&&a.push(o[e].value);return a}function l(){var e=setInterval(function(){if(AMap&&AMap.LngLat){clearInterval(e),k.clubAddress=k.info.club.address;var a={zoom:15};k.info.club.laty&&k.info.club.lngx&&($("#map-lngx").val(k.info.club.lngx),$("#map-laty").val(k.info.club.laty),a.center=new AMap.LngLat(k.info.club.lngx,k.info.club.laty)),r=new AMap.Map("loc-map",{resizeEnable:!0,view:new AMap.View2D(a),isHotspot:!0}),k.info.club.laty&&k.info.club.lngx&&AMap.event.addListener(r,"complete",function(){var e=new AMap.Marker({position:new AMap.LngLat(k.info.club.lngx,k.info.club.laty),offset:new AMap.Pixel((-10),(-34)),icon:"./img/common/mark_bs.png"});e.setMap(r)}),AMap.event.addListener(r,"click",function(e){$(".amap-icon").remove(),n([e.lnglat.getLng(),e.lnglat.getLat()]),new AMap.InfoWindow({isCustom:!0,autoMove:!1,content:'<img src="./img/common/mark_bs.png" />',offset:new AMap.Pixel(0,8)}).open(r,e.lnglat)});var o;r.plugin(["AMap.Autocomplete"],function(){AMap.event.addDomListener(C[0],"input",function(){var e=C.val();e?(o=new AMap.Autocomplete({pageIndex:1,pageSize:10,city:""}),AMap.event.addListener(o,"complete",t),o.search(e)):T.hide()})}),T.on("click","div",function(){var e=this.innerHTML.replace(/<[^>].*?>.*<\/[^>].*?>/g,"");C.val(e),r.plugin(["AMap.PlaceSearch"],function(){var a=new AMap.PlaceSearch;AMap.event.addListener(a,"complete",i),a.search(e)}),T.hide()})}},100)}function n(e){$("#map-lngx").val(e[0]),$("#map-laty").val(e[1]),new AMap.Geocoder({radius:1e3,extensions:"all"}).getAddress(e,function(e,a){"complete"===e&&"OK"===a.info&&($("#format-address").val(a.regeocode.formattedAddress),k.clubAddress=a.regeocode.formattedAddress)})}function t(e){var a="",o=[];if(e.tips){if(o=e.tips,o.length>0)for(var l=0;l<o.length;l++)a+="<div >"+o[l].name+"<span>"+o[l].district+"</span></div>";else a="无搜索结果，请重新输入!";T[0].innerHTML=a,T.show()}}function i(e){r.clearMap();var a=e.poiList.pois;a.forEach(function(e,a){var o,l;e.location?(o=e.location.getLng(),l=e.location.getLat()):(o=e._location.getLng(),l=e._location.getLat());var t={map:r,icon:"http://webapi.amap.com/images/"+(a+1)+".png",position:new AMap.LngLat(o,l)},i=new AMap.Marker(t);AMap.event.addListener(i,"click",function(e){n([o,l])})}),a[0]&&r.setZoomAndCenter(16,[a[0].location.getLng(),a[0].location.getLat()])}var c,s,u,r,d,v,p=$$.rootVm.page+"Ctrl"+ +new Date,g=$("#"+$$.rootVm.page+"Page"),f=$("#changePw-currPw"),m=$("#changePw-newPw"),h=$("#changePw-repeatNewPw"),b=$("div#clubInfoModal>div>div.content>div.email"),w=$("#clubInfo-name"),M=$("#clubInfo-contacts"),x=$("#clubInfo-mobilePhone"),A=$("#clubInfo-telephone"),L=$("#clubInfo-email"),I=$("#clubInfo-address"),y=$("#editLogoModal>div>div.content"),C=$("#locSearch"),T=$("#autoSearchRes");g.attr("ms-controller",p),$$.currPath.html("<a href='#!/home'>资料设置</a> >> 会所资料");var k=avalon.define({$id:p,info:{},currTelCount:0,clubAddress:"",doChangePw:function(){f.val(""),m.val(""),h.val(""),c.show()},doEditClubInfo:function(){$("div#clubInfoModal>div>div.content>div.del").remove(),w.val(k.info.club.name),M.val(k.info.club.contacts),x.val(k.info.club.mobilePhone),L.val(k.info.club.email),I.val(k.info.club.address),$("#clubInfo-lngx").val(k.info.club.lngx),$("#clubInfo-laty").val(k.info.club.laty);var e=k.info.club.telephone.split(",")||[];if(k.currTelCount=e.length,0!=e.length){if(A.val(e[0]),e.length>1)for(var a=1;a<e.length;a++)$("<div class='tel del'><label></label><input type='text' value='"+e[a]+"' maxlength='15' placeholder='请输入客服电话'/><i></i></div>").insertBefore(b)}else A.val("");s.show()},doLocMap:function(){u.show()},doClickEditLogo:function(){k.info.club.imageUrl&&v.load(k.info.club.imageUrl,{autoCropArea:1,disabled:!0}),d.show()}});c=new Modal($("#changePwModal"),{doClickOkBtn:function(){e()&&(c.loading(),$.ajax({url:"profile/password/update",type:"post",data:{password:f.val(),plainPassword:m.val()},success:function(e){200==e.statusCode?(c.close(),msgAlert(e.msg,!0)):c.showTip(e.msg)},complete:function(e){c.loading("hide"),200==e.status?(c.close(),msgAlert("账号密码修改成功！",!0)):400==e.status&&c.showTip(e.responseText)}}))}}),$("#changePwModal>div>div.content").on("input","div>input",function(){this.value.length>30&&(this.value=this.value.substr(0,30)),/\s/.test(this.value)&&(this.value=this.value.replace(/\s/g,""))}).on("keypress","div>input",function(e){13==e.keyCode&&$("#changePwModal>div>div.footer>a:eq(0)").click()}),s=new Modal($("#clubInfoModal"),{doClickOkBtn:function(){a()&&(s.loading(),$.ajax({url:"profile/club/update",type:"post",data:{name:w.val(),contacts:M.val(),mobilePhone:x.val(),email:L.val(),address:I.val(),lngx:$("#clubInfo-lngx").val(),laty:$("#clubInfo-laty").val(),telephone:o().join(",")},success:function(e){s.loading("hide"),200==e.statusCode?(s.close(),msgAlert(e.msg,!0),k.info.club.name=w.val(),k.info.club.contacts=M.val(),k.info.club.mobilePhone=x.val(),k.info.club.email=L.val(),k.info.club.address=I.val(),k.info.club.lngx=$("#clubInfo-lngx").val(),k.info.club.laty=$("#clubInfo-laty").val(),k.info.club.telephone=o().join(",")):s.showTip(e.msg||"操作失败！")}}))}}),$("#clubInfoModal>div>div.content").on("click","div.del>i",function(){$(this).parents("div.tel").remove(),k.currTelCount=k.currTelCount-1}),$("#clubInfoModal>div>div.content").on("click","div.plus>i",function(){$("<div class='tel del'><label></label><input type='text' maxlength='15' placeholder='请输入客服电话'/><i></i></div>").insertBefore(b),k.currTelCount=k.currTelCount+1}),x.on("input",function(){/\D/.test(this.value)&&(this.value=this.value.replace(/\D/g,"")),1==this.value.length&&1!=this.value&&(this.value=""),2!=this.value.length||/^1[34578]$/.test(this.value)||(this.value=1),this.value.length>11&&(this.value=this.value.substring(0,11))}),$("#clubInfoModal>div>div.content").on("input","div.tel>input",function(){/[^-|\d]/.test(this.value)&&(this.value=this.value.replace(/[^-|\d]/g,"")),this.value.length>15&&(this.value=this.value.substring(0,15))}),u=new Modal($("#clubLocModal"),{doClickOkBtn:function(){$("#clubInfo-lngx").val($("#map-lngx").val()),$("#clubInfo-laty").val($("#map-laty").val()),I.val(k.clubAddress),u.close()}}),$("#club-logo")[0].onerror=function(){this.src="club-admin/img/common/clubLogo.jpg"},d=new Modal($("#editLogoModal"),{doClickOkBtn:function(){if($("#clubLogoForm>div>img")[0]&&0!=$("#clubLogoForm>div>img")[0].width)if($("#uploadImgBtn")[0].files[0]){var e=v.checkSelectionValidate();if("OK"!=e)return void d.showTip(e);d.loading(),$("#clubLogoForm").ajaxSubmit({dataType:"json",success:function(e){e&&e.avatarUrl?($("#club-logo")[0].src=e.avatarUrl,$("header>div.logo>img")[0].src=e.avatarUrl,k.info.club.imageUrl=e.avatarUrl,d.close(),msgAlert("修改成功！",!0)):d.showTip(e.msg||e.message||"修改失败！")},complete:function(e){d.loading("hide"),400==e.status&&d.showTip("您选择的裁剪区域过大！请通过鼠标缩小区域！")}})}else d.close();else d.showTip("请您上传图片！")}}),v=new iCropper({imgFile:$("#uploadImgBtn")[0],img:$("#clubLogoForm>div>img")[0],selectionTxt:$("#clubLogoForm>div>span.selectionTxt")[0],imgName:$("#imgFileName")[0],maxWidth:580,maxHeight:300,x:$("#x")[0],y:$("#y")[0],w:$("#w")[0],h:$("#h")[0],imgWidth:168,imgHeight:168,onImgLoad:function(){y.hasClass("hasImg")||y.addClass("hasImg")}}),$.ajax({url:"profile/data",success:function(e){200==e.statusCode&&(k.info=e.respData,$("#club-logo")[0].src=e.respData.club.imageUrl||"",avalon.scan(g[0]),k.info.club.indexQrcodeUrl&&/^http/.test(k.info.club.indexQrcodeUrl)?$("#club-qrcode-img")[0].src=k.info.club.indexQrcodeUrl:$.ajax({url:"club/get/qrcode",type:"post",success:function(e){200==e.statusCode&&($("#club-qrcode-img")[0].src=e.respData)}}),$.ajax({url:"api/v1/wx/club/param_qrcode",data:{clubId:e.respData.club.clubId},success:function(e){200==e.statusCode&&($("#registeredQrCode")[0].src=e.respData)}}),l())}}),$("#qrPayCode").qrcode({width:430,height:430,text:location.origin+(location.pathname.split(";")[0]+"spa2/?#qrPay&clubId="+$$.clubId),roundBlank:!0})});
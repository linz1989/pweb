require(["css!../../compressed/css/page/"+$$.rootVm.page+".css?"+$$.rootVm.currTime,"daterangepicker","!domReady"],function(){function t(){if(""==v.currStatus)v.dataList=s;else for(var t=[],e=0;e<s.length;e++)s[e].actStatus==v.currStatus&&t.push(s[e]),v.dataList=t}function e(){return p.val()?r.val()?v.couponFee.indexOf("%")<0&&parseInt(p.val())<v.couponFee/100?(c.showTip("购买金额不能小于信息费！"),!1):!(m.html()&&m.html().length>1e3)||(c.showTip("使用说明输入太多了！"),!1):(c.showTip("请输入优惠金额！"),r.focus(),!1):(c.showTip("请输入实际购买金额！"),p.focus(),!1)}function a(){$.ajax({url:"act/list",success:function(e){200==e.statusCode&&(e=e.respData,s="on"!=e.paidCouponsSwitch?[]:e.paidCoupons,t(),avalon.scan(u[0]))}})}var o,n,c,i=$$.rootVm.page+"Ctrl"+ +new Date,u=$("#"+$$.rootVm.page+"Page"),s=[],d=$("#confirmModal"),l=$("#confirmModal>div>div.content"),p=$("#editActValue"),r=$("#editActConsumeMoney"),m=$("#editActContent"),h=$("#editPeriod");u.attr("ms-controller",i),$$.currPath.html("营销中心 >> 点钟券");var v=avalon.define({$id:i,couponSwitch:"off",dataList:[],statusObj:[{name:"全部状态",value:""},{name:"使用中",value:"online"},{name:"未上线",value:"not_online"},{name:"已下线",value:"downline_can_use"},{name:"已过期",value:"ne_lose_efficacy"},{name:"已失效",value:"disable"}],currStatus:"",couponFee:"",couponFeeStr:"",detailObj:{actValue:"",consumeMoney:"",couponPeriod:"",actContent:"",incomeType:""},editObj:{actId:"",actValue:"",consumeMoney:"",couponPeriod:"30",actContent:"",incomeType:"tech"},dayOptionArr:[{name:"1天",value:"1"},{name:"2天",value:"2"},{name:"3天",value:"3"},{name:"7天",value:"7"},{name:"10天",value:"10"},{name:"30天",value:"30"},{name:"60天",value:"60"},{name:"90天",value:"90"}],editModalTitle:"添加点钟券",doChangeStatus:function(){v.currStatus=this.value,t()},doChangeCouponStatus:function(t,e,a){var n="online"==a?"上线":"delete"==a?"删除":"下线";d.attr("opeType",a),d.attr("actId",t),d.attr("actType",e),l.text("确定要"+n+"此点钟券？"),o.show()},doCopyCoupon:function(t,e){$.ajax({url:"act/copy",data:{id:t,operator:"copy",actType:e},success:function(t){200==t.statusCode?(msgAlert(t.msg,!0),a()):msgAlert(t.msg||"操作失败！")}})},doEditViewCoupon:function(t){"查看"==this.innerHTML?(v.detailObj=v.dataList[t],$("#detailActContent").html(v.detailObj.actContent),n.show()):(v.editModalTitle="编辑点钟券",v.editObj.actId=v.dataList[t].actId,v.editObj.actValue=v.dataList[t].actValue,v.editObj.consumeMoney=v.dataList[t].consumeMoney,v.editObj.couponPeriod=parseInt(v.dataList[t].couponPeriod.substr(5))+"",v.editObj.actContent=v.dataList[t].actContent,v.editObj.incomeType=v.dataList[t].incomeType,m.html(v.editObj.actContent),c.show())},doAddCoupon:function(){v.editModalTitle="添加点钟券",v.editObj={actId:"",actValue:"",consumeMoney:"",couponPeriod:"30",actContent:"",incomeType:"tech"},$("#editActContent").html("使用时，出示您的二维码或者优惠码。"),c.show()},doSaveCoupon:function(t){e()&&$.ajax({url:"act/modify",type:"post",data:{operator:""==v.editObj.actId?"add":"modify",saveType:t,actId:v.editObj.actId,actType:"coupon",couponType:"paid",actValue:p.val(),consumeMoney:r.val(),periodType:"fixed_time",periodDay:h.val(),actContent:m.html(),incomeType:v.editObj.incomeType},success:function(t){200==t.statusCode?(c.close(),msgAlert(t.msg,!0),a()):c.showTip(t.msg||"操作失败！")}})},doChangeIncomeType:function(t){"active"!=this.className&&(v.editObj.incomeType=t)}});o=new Modal(d,{doClickOkBtn:function(){$.ajax({url:"act/modify",data:{actId:d.attr("actId"),operator:d.attr("opeType"),actType:d.attr("actType")},success:function(t){200==t.statusCode?(msgAlert(t.msg,!0),a()):msgAlert(t.msg||"操作失败！")}}),o.close()}}),n=new Modal($("#couponDetailModal")),c=new Modal($("#couponEditModal")),$("#editActValue,#editActConsumeMoney").on("input",function(){/\D/.test(this.value)&&(this.value=this.value.replace(/\D/g,"")),this.value.length>5&&(this.value=this.value.substr(0,5))}),a(),$.ajax({url:"api/v2/manager/paid_order/open_status",success:function(t){if(200==t.statusCode){v.couponSwitch=t.respData.couponSwitch;var e=t.respData.couponPlatformFee;v.couponFee=e,e.indexOf("%")>0?v.couponFeeStr=e:v.couponFeeStr=e/100+"元","on"==v.couponSwitch&&a()}}})});
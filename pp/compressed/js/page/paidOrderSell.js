require(["css!../../compressed/css/page/"+$$.rootVm.page+".css?"+$$.rootVm.currTime,"!domReady"],function(){function r(){$.ajax({url:"cluborder/view",success:function(r){200==r.statusCode&&(r=r.respData,a.paidOrderDownPayment=r.downPayment||0,a.paidOrderExpireCommission=r.expireCommission||0,a.paidOrderTechCommission=r.techCommission||0,a.paidOrderStartTime=r.startTime||"00:00",a.paidOrderEndTime=r.endTime||"23:59",a.paidOrderConfId=r.id,"00:00"==a.paidOrderStartTime&&"23:59"==a.paidOrderEndTime&&$("#paidOrderAllDay").addClass("active"),$("#paidOrderStartTime").val(a.paidOrderStartTime),$("#paidOrderEndTime").val(a.paidOrderEndTime))}})}var e=$$.rootVm.page+"Ctrl"+ +new Date,i=$("#"+$$.rootVm.page+"Page");i.attr("ms-controller",e),$$.currPath.html("营销中心 >> 付费预约");var a=avalon.define({$id:e,paidOrderStartTimeArr:[],paidOrderEndTimeArr:[],paidOrderUserSwitch:"off",paidOrderSysSwitch:"off",paidOrderPlatformFree:"",paidOrderDownPayment:"",paidOrderExpireCommission:"",paidOrderTechCommission:"",paidOrderStartTime:"",paidOrderEndTime:"",paidOrderConfId:"",doChangeEndTime:function(){a.paidOrderEndTime=this.value,$("#paidOrderAllDay").removeClass("active")},doChangeStartTime:function(){a.paidOrderStartTime=this.value,$("#paidOrderAllDay").removeClass("active")},doClickAllDay:function(){"active"==this.className?this.className="":(this.className="active",a.paidOrderStartTime="00:00",a.paidOrderEndTime="23:59",$("#paidOrderStartTime").val(a.paidOrderStartTime),$("#paidOrderEndTime").val(a.paidOrderEndTime))},doClickSwitch:function(){var e="active"==this.className;this.className=e?"":"active";var i=this;$.ajax({url:"cluborder/open_or_off",data:{status:e?"off":"on"},success:function(d){200==d.statusCode?(a.paidOrderUserSwitch=e?"off":"on",e||r()):(msgAlert("操作失败！"),i.className=e?"active":"")}})},doSave:function(){if(a.paidOrderDownPayment=a.paidOrderDownPayment.replace(/\D/g,"").substring(0,6),a.paidOrderExpireCommission=a.paidOrderExpireCommission.replace(/\D/g,"").substring(0,6),a.paidOrderTechCommission=a.paidOrderTechCommission.replace(/\D/g,"").substring(0,6),a.paidOrderDownPayment=a.paidOrderDownPayment||0,a.paidOrderExpireCommission=a.paidOrderExpireCommission||0,a.paidOrderTechCommission=a.paidOrderTechCommission||0,0!=parseInt(a.paidOrderTechCommission)&&parseInt(a.paidOrderTechCommission)>=parseInt(a.paidOrderDownPayment))return void msgAlert("核销提成须小于预约定金！");if(0!=parseInt(a.paidOrderExpireCommission)&&parseInt(a.paidOrderExpireCommission)>=parseInt(a.paidOrderDownPayment))return void msgAlert("过期提成须小于预约定金！");var r=parseInt(a.paidOrderExpireCommission)+("元"==a.paidOrderPlatformFree.slice(-1)?parseFloat(a.paidOrderPlatformFree):parseInt(a.paidOrderPlatformFree)/100*parseInt(a.paidOrderDownPayment)),e=parseInt(a.paidOrderTechCommission)+("元"==a.paidOrderPlatformFree.slice(-1)?parseFloat(a.paidOrderPlatformFree):parseInt(a.paidOrderPlatformFree)/100*parseInt(a.paidOrderDownPayment));return 0!=r&&r>parseInt(a.paidOrderDownPayment)||0!=e&&e>parseInt(a.paidOrderDownPayment)?void msgAlert("提成+手续费须小于预约定金！"):void $.ajax({url:"cluborder/save",data:{downPayment:a.paidOrderDownPayment,expireCommission:a.paidOrderExpireCommission,techCommission:a.paidOrderTechCommission,startTime:$("#paidOrderStartTime").val(),endTime:$("#paidOrderEndTime").val(),id:a.paidOrderConfId},success:function(r){200==r.statusCode&&msgAlert(r.msg||"保存成功！",!0)}})}});$("#paidOrderForm").on("input","li>input[type=text]",function(){/\D/.test(this.value)&&(this.value=this.value.replace(/\D/g,"")),this.value.length>6&&(this.value=this.value.substr(0,6))}),$.ajax({url:"api/v2/manager/paid_order/open_status",success:function(e){if(200==e.statusCode&&(e=e.respData,a.paidOrderSysSwitch="Y"==e.payAppointment?"on":"off",a.paidOrderUserSwitch=e.openStatus,a.paidOrderPlatformFree=e.platformFee.indexOf("%")>0?e.platformFee:parseFloat(e.platformFee||0)/100+"元","on"==a.paidOrderSysSwitch)){for(var d=[],t=0;t<24;t++)d.push((t<10?"0"+t:t)+":00"),d.push((t<10?"0"+t:t)+":30");a.paidOrderStartTimeArr=d,d.push("23:59"),a.paidOrderEndTimeArr=d,avalon.scan(i[0]),"on"==a.paidOrderUserSwitch&&r()}}})});
require(["css!../../compressed/css/page/clubService.css?"+$$.rootVm.currTime,"css!../../compressed/css/common/kindeditor.css","kindeditor","kindeditor_zhCn","jqform","cropper","dragsort","!domReady"],function(){function e(){return $("#editForm>div.img>img")[0]&&0==$("#editForm>div.img>img")[0].width&&!$("#imgFileName").val()?(d.showTip("请上传项目图片！"),!1):c.val()?($("#imgFileName").val()&&C.val(""),!0):(c.focus(),d.showTip("请输入项目名称！"),!1)}function i(){$.ajax({url:"club/service/itemList/"+w.id,success:function(e){e.title&&e.list&&(T.itemName=e.title,$$.currPath.html("资料设置 >> <a href='#!/clubServiceSetting'>服务项目</a> >>"+e.title),T.items=e.list),avalon.scan(s[0])}})}function t(e){l=KindEditor.editor({fileManagerJson:"club/service/photoGallery/data?id="+e,allowFileManager:!0}),KindEditor("#fileManager").click(function(){l.loadPlugin("filemanager",function(){l.plugin.filemanagerDialog({viewType:"VIEW",dirName:"image",clickFn:function(e){o.clean(),o.load("updateImageInfo/imageView/"+e,{autoCropArea:1,disabled:!0}),n.addClass("hasImg"),C.val(e),l.hideDialog()}})})})}var a,d,o,l,r=$$.rootVm.page+"Ctrl"+ +new Date,s=$("#"+$$.rootVm.page+"Page"),n=$("#editForm"),c=$("#itemName"),m=$("#itemPrice0"),u=$("#itemTime0"),g=$("#durationUnit"),v=$("#itemPrice1"),p=$("#itemTime1"),h=$("#durationUnitPlus"),f=$("#itemDescription"),I=$("#itemDescriptionContent"),C=$("#currEditImageId"),w=getParamObj();w.id||(msgAlert("地址栏访问参数错误！"),history.back()),s.attr("ms-controller",r),$$.currPath.html("资料设置 >> <a href='#!/clubServiceSetting'>服务项目</a>");var T=avalon.define({$id:r,items:[],categoryId:w.id,itemName:"",opeType:"",opeId:"",confirmContent:"",units:["分钟","小时","天","次"],addPlus:!1,currEditId:"",currEditTitle:"添加项目",doClickOfDel:function(e){T.opeId=e,T.opeType="del",T.confirmContent="确认删除此项目？",a.show()},doClickOfRemoveIndex:function(e){T.opeId=e,T.opeType="removeIndex",T.confirmContent="确定要将此项目移除出首页吗？",a.show()},doClickOfAddIndex:function(e){T.opeId=e,T.opeType="addIndex",T.confirmContent="确定要将此项目推荐到首页吗？",a.show()},doClickOfAdd:function(){T.currEditId="",T.currEditTitle="添加项目",C.val(""),c.val(""),m.val(""),u.val(""),g.val("分钟"),f.val(""),I.html(""),T.addPlus=!1,v.val(""),p.val(""),h.val("分钟"),o.clean(),n.removeClass("hasImg"),d.show()},doClickOfEdit:function(e){var i=T.items[e];T.currEditId=i.id,T.currEditTitle="编辑项目",C.val(i.image),c.val(i.name),m.val(i.price),u.val(i.duration),g.val(i.durationUnit),f.val(i.description),I.html(i.description),""!=i.pricePlus?(T.addPlus=!0,v.val(i.pricePlus),p.val(i.durationPlus),h.val(i.durationUnitPlus)):(T.addPlus=!1,v.val(""),p.val("")),i.imageUrl?(o.load(i.imageUrl,{autoCropArea:1,disabled:!0}),n.addClass("hasImg")):(o.clean(),n.removeClass("hasImg")),d.show()},doClickAddPlus:function(){T.addPlus=!0},doClickRemovePlus:function(){T.addPlus=!1}});a=new Modal($("#confirmModal"),{doClickOkBtn:function(){"del"==T.opeType?$.ajax({url:"club/service/item/delete",data:{id:T.opeId},success:function(e){a.close(),200==e.statusCode?(msgAlert("删除成功！",!0),i()):msgAlert(e.message)}}):$.ajax({url:"club/service/item/devaluation",data:{recommended:"removeIndex"==T.opeType?"Y":"N",id:T.opeId},success:function(e){a.close(),200==e.statusCode?(msgAlert(e.msg,!0),i()):msgAlert(e.msg)}})}}),d=new Modal($("#editItemModal"),{doClickOkBtn:function(){if(e()){if(f.val(I.html()),$("#editForm>div.img>img")[0]&&0!=$("#editForm>div.img>img")[0].width&&$("#uploadImgBtn")[0].files[0]){var t=o.checkSelectionValidate();if("OK"!=t)return void d.showTip(t)}d.loading(),n.ajaxSubmit({url:""==T.currEditId?"club/service/serviceItem/create":"club/service/serviceItem/update",dataType:"json",success:function(e){200==e.statusCode?(msgAlert(""==T.currEditId?"添加成功！":"修改成功！",!0),d.close(),i()):d.showTip(e.message||"操作失败！")},complete:function(e){d.loading("hide"),400==e.status&&d.showTip("您选择的裁剪区域过大！请通过鼠标缩小区域！")}})}}}),$("#editForm").on("input","div.price>input",function(){/\D/.test(this.value)&&(this.value=this.value.replace(/\D/g,"")),this.value.length>6&&(this.value=this.value.substr(0,6))}),o=new iCropper({imgFile:$("#uploadImgBtn")[0],img:$("#editForm>div.img>img")[0],imgName:$("#imgFileName")[0],imgId:$("#currEditImageId")[0],selectionTxt:$("#editForm>div.img>span.selectionTxt")[0],maxWidth:580,maxHeight:230,x:$("#x")[0],y:$("#y")[0],w:$("#w")[0],h:$("#h")[0],imgWidth:324,imgHeight:324,ratioW:1,ratioH:1,onImgLoad:function(){n.hasClass("hasImg")||n.addClass("hasImg")}}),$("#serviceItemList").dragsort({dragSelector:"li",dragSelectorExclude:"div>ul>li",dragEnd:function(){for(var e=$(this),i=e.parents("ul").children(),t=[],a=0;a<i.length;a++)t.push(i[a].getAttribute("itemId"));$.ajax({url:"club/service/sort",type:"post",data:{ids:t.join(","),categoryId:w.id},success:function(e){200==e.statusCode&&msgAlert("排序成功！",!0)}})}}),t(w.id),i()});